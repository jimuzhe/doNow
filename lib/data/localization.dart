import 'dart:ui' as ui;
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'services/storage_service.dart';
import 'providers.dart';

// 1. Provider for current Locale 'en' or 'zh' - Now with persistence and system detection
final localeProvider = StateNotifierProvider<LocaleNotifier, String>((ref) {
  final storage = ref.watch(storageServiceProvider);
  return LocaleNotifier(storage);
});

class LocaleNotifier extends StateNotifier<String> {
  final StorageService _storage;

  LocaleNotifier(this._storage) : super(_detectSystemLocale()) {
    // Auto-load from storage on init
    _loadFromStorage();
  }

  /// Detect system language and return 'zh' if Chinese, otherwise 'en'
  static String _detectSystemLocale() {
    final systemLocale = ui.PlatformDispatcher.instance.locale;
    // Check if system language is Chinese (zh, zh_CN, zh_TW, zh_HK, etc.)
    if (systemLocale.languageCode == 'zh') {
      return 'zh';
    }
    return 'en';
  }

  void _loadFromStorage() {
    try {
      final savedLocale = _storage.loadLocale();
      if (savedLocale != null) {
        // User has previously selected a language, use it
        state = savedLocale;
      }
      // If null, keep the system-detected locale (already set in super())
    } catch (_) {
      // Storage not initialized yet, use system-detected defaults
    }
  }

  void setLocale(String locale) {
    state = locale;
    _storage.saveLocale(locale);
  }
}

// 2. String Map
class AppStrings {
  static const Map<String, Map<String, String>> _localizedValues = {
    'en': {
      'home': 'Home',
      'analysis': 'Analysis',
      'settings': 'Settings',
      'do_now': 'DO NOW',
      'slogan': 'ACTION BEATS ANXIETY',
      'tap_to_start': 'Tap to start a mission',
      'step_1': 'STEP 1/2',
      'step_2': 'STEP 2/2',
      'what_to_do': 'What to do?',
      'how_long': 'How long?',
      'when_to_start': 'When to start?',
      'repeat_daily': 'Repeat Daily',
      'next': 'Next',
      'back': 'Back',
      'create_mission': 'Create Mission',
      'cancel': 'Cancel',
      'save': 'Save',
      'language': 'Language',
      'now': 'Now',
      'laters': 'Later',
      'repeat': 'Repeat',
      'mon_fri': 'Mon-Fri',
      'daily': 'Daily',
      'no_repeat': 'No Repeat',
      'generating': 'Generating mission...',
      'generating_desc': 'AI is crafting your plan',
      'quote_1': 'Small steps lead to big changes.',
      'quote_2': 'Action is the foundational key to all success.',
      'quote_3': 'You are closer than you think.',
      'day_1': 'Mon', 'day_2': 'Tue', 'day_3': 'Wed', 'day_4': 'Thu', 'day_5': 'Fri', 'day_6': 'Sat', 'day_7': 'Sun',
      'feedback': 'Feedback',
      'about': 'About',
      'about_title': 'About Do Now',
      'about_content': 'Do Now is a minimalist task manager designed to help you overcome procrastination. \n\nWe believe that action beats anxiety. By breaking down tasks into atomic steps with AI, we make starting easier.',
      'feedback_email': 'longdz6299@gmail.com',
      'copy_email': 'Copy Email',
      'email_copied': 'Email copied to clipboard',
      'dark_mode': 'Dark Mode',
      'light_mode': 'Light Mode',
      'theme_system': 'System',
      'error_ai_timeout': 'AI is taking too long. Please try again.',
      'error_ai_generic': 'Something went wrong. Please check your connection.',
      'retry': 'Retry',
      'clear_data': 'Clear Data',
      'theme': 'Theme',
      'version': 'Version',
      'analysis_title': 'ANALYSIS',
      'completed': 'Completed',
      'focus_minutes': 'Focus Minutes',
      'weekly_activity': 'WEEKLY ACTIVITY',
      'slide_do': 'DO',
      'slide_edit': 'Edit',
      'slide_drop': 'Drop',
      'complete_mission': 'COMPLETE MISSION',
      'abort_mission': 'Abort',
      'abort_title': 'Abort Mission?',
      'abort_content': 'Do you want to delay it or cancel entirely?',
      'btn_quit': 'Quit',
      'times_up': 'Time\'s Up!',
      'times_up_content': 'Did you complete the mission?',
      'btn_no': 'No',
      'btn_yes': 'Yes, I did it!',
      'mission_accomplished': 'MISSION\nACCOMPLISHED',
      'great_work': 'Great work!',
      'ai_config': 'AI Configuration',
      'encourage_title': 'Don\'t give up.',
      'encourage_content': 'Every step counts. You can try again later.',
      'reschedule': 'Reschedule',
      'ok_cool': 'It\'s okay',
      'edit_mission': 'Edit Mission',
      'abandoned': 'Abandoned',
      'completed_tasks': 'COMPLETED TASKS',
      'abandoned_tasks': 'ABANDONED TASKS',
      'pending_tasks': 'PENDING TASKS',
      'steps': 'steps',
      'no_tasks_yet': 'No tasks yet',
      'time_in_past': 'Cannot schedule task in the past',
      'task_starting': 'Task is starting now!',
      'vibration_intensity': 'Vibration Intensity',
      'vibration_off': 'Off',
      'vibration_light': 'Light',
      'vibration_medium': 'Medium',
      'vibration_strong': 'Strong',
      'time_saved': 'Time Saved',
      'time_extra': 'Extra Time',
      'total_time': 'Total Time',
      'feedback_early': 'Speedy Warrior!',
      'feedback_early_desc': 'You finished ahead of schedule.',
      'feedback_late': 'Persistence pays off!',
      'feedback_late_desc': 'Better late than never.',
      'actual_time': 'Actual Time',
      'planned_time': 'Planned Time',
      'ai_estimate': 'AI Estimate',
      'estimating': 'Estimating...',
      'ai_ready': 'AI plan ready - will skip generation on next step',
      'enter_title_first': 'Please enter task title first',
      'estimated': 'Estimated',
      'minutes': 'min',
      'edit_steps': 'Edit Steps',
      'remaining': 'Remaining',
      'exceeded': 'Exceeded',
      'add_step': 'Add Step',
      'step_title': 'Step title...',
      'step': 'Step',
      'start_now': 'Start Now',
      'confirm_steps': 'Confirm Steps',
      'clear_data_title': 'Clear All Data?',
      'clear_data_confirm': 'This will delete all your tasks and statistics. This action cannot be undone.',
      'data_cleared': 'All data has been cleared',
      'confirm_clear': 'Clear All',
      'security_error': 'Sorry, your content contains sensitive keywords, please edit and try again.',
      // AI Persona
      'ai_persona': 'AI Persona',
      'persona_rushed': 'Rushed',
      'persona_rushed_desc': 'Shorter time estimates, faster completion',
      'persona_balanced': 'Balanced',
      'persona_balanced_desc': 'Standard time estimates',
      'persona_relaxed': 'Relaxed',
      'persona_relaxed_desc': 'More buffer time, detailed steps',
      // Analysis & Journaling
      'weekly_completion_rate': 'Weekly Completion Rate',
      'total_focus_time': 'Total Focus Time',
      'journal_add_record': 'Add Record',
      'journal_location_toggle': 'Location Tag',
      'journal_location_on': 'ON',
      'journal_location_off': 'OFF',
      'journal_save': 'Save Record',
      'journal_skip': 'Skip',
      'journal_capture': 'Capture the moment',
      'journal_photo': 'Photo',
      'journal_video': 'Video',
      'journal_gallery': 'Gallery',
      // Analysis Screen - New
      'completion_rate': 'Completion Rate',
      'streak': 'Streak',
      'days': 'days',
      'tasks': 'tasks',
      'no_activity': 'No activity recorded',
      'daily_summary': 'Daily Summary',
      'focus_time': 'Focus',
      'generating_summary': 'Generating AI summary...',
      'no_tasks_to_summarize': 'No tasks to summarize for this day',
      'ai_insight': 'AI Insight',
      'daily_summary_too_early': 'Daily summary will be generated tomorrow at 8:00 AM.',
    },
    'zh': {
      'home': '首页',
      'analysis': '统计',
      'settings': '设置',
      'do_now': '即刻行动',
      'slogan': '行动战胜焦虑',
      'tap_to_start': '点击开始新任务',
      'step_1': '第 1 步 / 共 2 步',
      'step_2': '第 2 步 / 共 2 步',
      'what_to_do': '你要做什么？',
      'how_long': '需要多久？',
      'when_to_start': '何时开始？',
      'repeat_daily': '每日重复',
      'next': '下一步',
      'back': '上一步',
      'create_mission': '创建任务',
      'cancel': '取消',
      'save': '保存',
      'language': '语言',
      'now': '现在开始',
      'laters': '稍后',
      'repeat': '重复',
      'mon_fri': '周一至周五',
      'daily': '每天',
      'no_repeat': '不重复',
      'generating': '正在生成...',
      'generating_desc': 'AI 正在规划任务',
      'quote_1': '不积跬步，无以至千里。',
      'quote_2': '行动是成功的基石。',
      'quote_3': '你比想象中更接近目标。',
      'day_1': '一', 'day_2': '二', 'day_3': '三', 'day_4': '四', 'day_5': '五', 'day_6': '六', 'day_7': '日',
      'feedback': '意见反馈',
      'about': '关于我们',
      'about_title': '关于 Do Now',
      'about_content': 'Do Now 是一款极简主义任务管理应用，旨在帮助您克服拖延症。\n\n我们相信行动战胜焦虑。通过 AI 将复杂的任务拆解为原子步骤，让开始变得更加简单。',
      'feedback_email': 'longdz6299@gmail.com',
      'copy_email': '复制邮箱',
      'email_copied': '邮箱已复制到剪贴板',
      'dark_mode': '深色模式',
      'light_mode': '浅色模式',
      'theme_system': '跟随系统',
      'error_ai_timeout': 'AI 响应超时，请重试。',
      'error_ai_generic': '发生错误，请检查网络连接。',
      'retry': '重试',
      'clear_data': '清除数据',
      'theme': '主题',
      'version': '版本',
      'analysis_title': '数据分析',
      'completed': '已完成',
      'focus_minutes': '专注时长 (分)',
      'weekly_activity': '本周活动',
      'slide_do': '开始',
      'slide_edit': '编辑',
      'slide_drop': '删除',
      'complete_mission': '完成任务',
      'abort_mission': '放弃任务',
      'abort_title': '放弃任务？',
      'abort_content': '您想要稍后处理还是直接放弃？',
      'btn_quit': '放弃',
      'times_up': '时间到！',
      'times_up_content': '您完成任务了吗？',
      'btn_no': '没完成',
      'btn_yes': '完成了！',
      'mission_accomplished': '任务达成',
      'great_work': '干得漂亮！',
      'ai_config': 'AI 配置',
      'encourage_title': '别灰心',
      'encourage_content': '每一步都算数，您可以稍后再试。',
      'reschedule': '推迟任务',
      'ok_cool': '好的',
      'edit_mission': '编辑任务',
      'abandoned': '已放弃',
      'completed_tasks': '已完成任务',
      'abandoned_tasks': '已放弃任务',
      'pending_tasks': '待处理任务',
      'steps': '步',
      'no_tasks_yet': '暂无任务',
      'time_in_past': '无法创建过去时间的任务',
      'task_starting': '任务即将开始！',
      'vibration_intensity': '震动强度',
      'vibration_off': '关闭',
      'vibration_light': '轻微',
      'vibration_medium': '中等',
      'vibration_strong': '强烈',
      'time_saved': '节省时间',
      'time_extra': '超出时间',
      'total_time': '总耗时',
      'feedback_early': '唯快不破！',
      'feedback_early_desc': '你提前完成了任务，太棒了！',
      'feedback_late': '坚持就是胜利！',
      'feedback_late_desc': '虽然超时了，但你做到了。',
      'actual_time': '实际耗时',
      'planned_time': '预定时间',
      'ai_estimate': 'AI 估时',
      'estimating': '估算中...',
      'ai_ready': 'AI 规划就绪 - 下一步将跳过生成',
      'enter_title_first': '请先输入任务标题',
      'estimated': '预估时间',
      'minutes': '分钟',
      'edit_steps': '编辑步骤',
      'remaining': '剩余',
      'exceeded': '超出',
      'add_step': '添加步骤',
      'step_title': '步骤名称...',
      'step': '步骤',
      'start_now': '立即开始',
      'confirm_steps': '确认步骤',
      'clear_data_title': '清除所有数据？',
      'clear_data_confirm': '这将删除所有任务和统计数据。此操作无法撤销。',
      'data_cleared': '所有数据已清除',
      'confirm_clear': '确认清除',
      'security_error': '抱歉，您所输入的内容含有违规信息，请重新编辑后再发送',
      // AI Persona
      'ai_persona': 'AI 角色',
      'persona_rushed': '匆忙型',
      'persona_rushed_desc': '估时更短，更快完成任务',
      'persona_balanced': '平衡型',
      'persona_balanced_desc': '标准时间估算',
      'persona_relaxed': '从容型',
      'persona_relaxed_desc': '更多缓冲时间，步骤更详细',
      // Analysis & Journaling
      'weekly_completion_rate': '周完成率',
      'total_focus_time': '总专注时长',
      'journal_add_record': '添加记录',
      'journal_location_toggle': '位置标记',
      'journal_location_on': '已开启',
      'journal_location_off': '未开启',
      'journal_save': '保存记录',
      'journal_skip': '跳过',
      'journal_capture': '记录此刻',
      'journal_photo': '拍照',
      'journal_video': '视频',
      'journal_gallery': '相册',
      // Analysis Screen - New
      'completion_rate': '完成率',
      'streak': '连续完成',
      'days': '天',
      'tasks': '个任务',
      'no_activity': '暂无活动记录',
      'daily_summary': '每日总结',
      'focus_time': '专注',
      'generating_summary': '正在生成AI总结...',
      'no_tasks_to_summarize': '当天没有可总结的任务',
      'ai_insight': 'AI 洞见',
      'daily_summary_too_early': '每日总结将于次日早 8 点生成。',
    }
  };

  static String get(String key, String locale) {
    return _localizedValues[locale]?[key] ?? key;
  }
}
