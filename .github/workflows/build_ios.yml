name: Build iOS IPA for TrollStore

on:
  push:
    branches: [ "main", "ios17-interactive" ]
  workflow_dispatch:

jobs:
  build_ios:
    name: Build iOS IPA
    runs-on: macos-14
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show Xcode Version
        run: xcodebuild -version

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Clean iOS Project
        run: |
          cd ios
          rm -rf Runner.xcodeproj
          rm -rf Runner.xcworkspace
          rm -rf Pods
          rm -f Podfile.lock
          cd ..
          flutter clean

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Generate Xcode Project
        run: |
          cd ios
          xcodegen generate
          cd ..

      - name: Generate App Icons
        run: |
          sed -i '' 's/ios: false/ios: true/' pubspec.yaml || true
          dart run flutter_launcher_icons || true

      - name: Pod Install
        run: |
          cd ios
          pod install --repo-update
          cd ..

      - name: Build Flutter Assets
        run: |
          # Set FLUTTER_ROOT environment variable
          export FLUTTER_ROOT=$(dirname $(dirname $(which flutter)))
          echo "FLUTTER_ROOT: $FLUTTER_ROOT"
          
          # Only build Flutter assets, don't try to build the full iOS app
          flutter build ios --release --no-codesign 2>&1 || true

      - name: Build with Xcodebuild (Ad-hoc Signing)
        run: |
          export FLUTTER_ROOT=$(dirname $(dirname $(which flutter)))
          echo "FLUTTER_ROOT: $FLUTTER_ROOT"
          
          cd ios
          
          # Build using xcodebuild with ad-hoc signing
          xcodebuild \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath build/Runner.xcarchive \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            FLUTTER_ROOT="$FLUTTER_ROOT" \
            clean archive 2>&1 | tee xcodebuild.log || true
          
          cd ..

      - name: Locate and Prepare App Bundle
        run: |
          echo "ðŸ” Searching for built app..."
          
          # Check archive first
          if [ -d "ios/build/Runner.xcarchive/Products/Applications/Runner.app" ]; then
            echo "âœ… Found app in archive"
            APP_SOURCE="ios/build/Runner.xcarchive/Products/Applications/Runner.app"
          elif [ -d "build/ios/Release-iphoneos/Runner.app" ]; then
            echo "âœ… Found app in Flutter build directory"
            APP_SOURCE="build/ios/Release-iphoneos/Runner.app"
          elif [ -d "ios/build/Release-iphoneos/Runner.app" ]; then
            echo "âœ… Found app in iOS build directory"
            APP_SOURCE="ios/build/Release-iphoneos/Runner.app"
          else
            echo "ðŸ” Searching all build directories..."
            find . -name "Runner.app" -type d 2>/dev/null
            
            # Try to find any Runner.app
            APP_SOURCE=$(find . -name "Runner.app" -type d 2>/dev/null | grep -v "Pods" | head -1)
            
            if [ -z "$APP_SOURCE" ]; then
              echo "âŒ Could not find Runner.app"
              echo "ðŸ“‹ Build log:"
              cat ios/xcodebuild.log || true
              exit 1
            fi
            echo "âœ… Found app at: $APP_SOURCE"
          fi
          
          # Prepare output directory
          mkdir -p build/ios/iphoneos
          cp -r "$APP_SOURCE" build/ios/iphoneos/Runner.app
          
          echo "âœ… App copied to build/ios/iphoneos/Runner.app"

      - name: Sign App for TrollStore
        run: |
          APP_PATH="build/ios/iphoneos/Runner.app"
          
          # Check if app bundle is valid
          if [ ! -f "$APP_PATH/Info.plist" ]; then
            echo "âŒ Invalid app bundle - Info.plist not found"
            ls -la "$APP_PATH" || true
            exit 1
          fi
          
          echo "ðŸ“± App bundle contents:"
          ls -la "$APP_PATH"
          
          # Sign all frameworks first
          if [ -d "$APP_PATH/Frameworks" ]; then
            echo "âœï¸ Signing frameworks..."
            find "$APP_PATH/Frameworks" -name "*.framework" -o -name "*.dylib" | while read framework; do
              codesign -f -s - "$framework" 2>/dev/null || true
            done
          fi
          
          # Sign Widget Extension
          WIDGET_PATH="$APP_PATH/PlugIns/DoNowWidget.appex"
          if [ -d "$WIDGET_PATH" ]; then
            echo "âœï¸ Signing DoNowWidget extension..."
            codesign -f -s - --entitlements ios/DoNowWidget/DoNowWidget.entitlements "$WIDGET_PATH"
          fi
          
          # Sign Main App
          echo "âœï¸ Signing Runner.app..."
          codesign -f -s - --entitlements ios/Runner/Runner.entitlements "$APP_PATH"
          
          # Verify signing
          echo "âœ… Verifying signature..."
          codesign -vv "$APP_PATH" || echo "âš ï¸ Signature verification had warnings (normal for ad-hoc)"
          
          echo "ðŸ“‹ Entitlements:"
          codesign -d --entitlements :- "$APP_PATH" 2>/dev/null || echo "Could not display entitlements"

      - name: Package IPA
        run: |
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r DoNow_TrollStore.ipa Payload
          echo "ðŸ“¦ IPA created:"
          ls -la DoNow_TrollStore.ipa
          
          # Calculate checksum
          shasum -a 256 DoNow_TrollStore.ipa
          cd ../../..

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: DoNow_TrollStore_IPA
          path: build/ios/iphoneos/DoNow_TrollStore.ipa
          
      - name: Upload Build Log (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-log
          path: ios/xcodebuild.log
